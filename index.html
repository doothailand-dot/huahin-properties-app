<!DOCTYPE html>
<html>
<head>
  <base target="_top"><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root { 
      --primary-green: #24d366; --app-red: #d32f2f;
      --st-available: #e8f5e9; --st-available-txt: #2e7d32;
      --st-reserved: #fff3e0; --st-reserved-txt: #e65100;
      --st-sold: #ffebee; --st-sold-txt: #c62828;
    }
    body { font-family: 'Kanit', sans-serif; background-color: #f4f4f4; margin: 0; padding: 0; }
    #loadingScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.5s; }
    .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-green); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .header { background-color: var(--primary-green); color: white; padding: 20px 15px 40px; text-align: center; border-radius: 0 0 30px 30px; position: relative; }
    .logo-circle { width: 60px; height: 60px; background: white; border-radius: 50%; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .logo-circle img { width: 85%; }
    .container { padding: 15px; max-width: 450px; margin: 0 auto 80px; }
    .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; text-align: left; }
    .input-group { margin-bottom: 15px; }
    .input-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; }
    .input-group input, .input-group textarea { width: 100%; padding: 12px; border: 1.5px solid #eee; border-radius: 10px; box-sizing: border-box; font-family: 'Kanit'; }
    .menu-btn { width: 100%; padding: 16px; background: var(--primary-green); color: white; border: none; border-radius: 50px; font-weight: 600; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .house-card { display: flex; background: white; border-radius: 12px; margin-bottom: 10px; padding: 10px; align-items: center; border-left: 5px solid var(--primary-green); position: relative; }
    .house-img { width: 75px; height: 75px; border-radius: 8px; object-fit: cover; }
    .house-info { flex: 1; padding: 0 12px; text-align: left; }
    .status-badge { position: absolute; top: 10px; right: 10px; font-size: 10px; padding: 4px 10px; border-radius: 12px; font-weight: 600; }
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; border-top: 1px solid #eee; z-index: 1000; }
    .nav-item { flex: 1; padding: 12px 0; text-align: center; font-size: 11px; color: #999; cursor: pointer; }
    .nav-item.active { color: var(--primary-green); }
  </style>
</head>
<body onload="initApp()">

  <div id="loadingScreen"><div class="spinner"></div><p>HUAHIN.PROPERTIES</p></div>

  <div class="header">
    <div class="logo-circle"><img src="https://img5.pic.in.th/file/secure-sv1/222892.jpg"></div>
    <h1 style="font-size: 18px; margin: 0;">HUAHIN.PROPERTIES</h1>
  </div>

  <div class="container">
    <div id="startPage" class="card" style="display:none; text-align: center;">
      <h3>Property Portal</h3>
      <button class="menu-btn" onclick="switchPage('loginPage')">‡πÄ‡∏≠‡πÄ‡∏à‡∏ô‡∏ï‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      <div style="margin: 15px 0; color:#ccc;">- ‡∏´‡∏£‡∏∑‡∏≠ -</div>
      <button class="menu-btn" onclick="openCustomerView()" style="background:#666;">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</button>
    </div>

    <div id="loginPage" class="card" style="display:none;">
      <h3>Login</h3>
      <div class="input-group"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label><input type="tel" id="lPhone"></div>
      <div class="input-group"><label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label><input type="password" id="lPass"></div>
      <button class="menu-btn" onclick="handleLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      <span onclick="switchPage('registerPage')" class="link-text" style="display:block; margin-top:15px; text-align:center; color:var(--primary-green); cursor:pointer;">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</span>
    </div>

    <div id="registerPage" class="card" style="display:none;">
      <h3>Register</h3>
      <div class="input-group"><label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" id="rName"></div>
      <div class="input-group"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label><input type="tel" id="rPhone"></div>
      <div class="input-group"><label>‡πÑ‡∏≠‡∏î‡∏µ‡πÑ‡∏•‡∏ô‡πå</label><input type="text" id="rLine"></div>
      <div class="input-group"><label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label><input type="password" id="rPass"></div>
      <button class="menu-btn" onclick="handleRegister()">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
    </div>

    <div id="visitPage" class="card" style="display:none;">
      <h3><i class="fa-solid fa-location-dot"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏≤‡∏ä‡∏°‡∏ö‡πâ‡∏≤‡∏ô</h3>
      <div style="background:#f8f9fa; padding:10px; border-radius:10px; margin-bottom:15px; font-size:13px;">
        <div><b>‡πÄ‡∏≠‡πÄ‡∏à‡∏ô‡∏ï‡πå:</b> <span id="vDispName">...</span></div>
        <div><b>‡∏£‡∏´‡∏±‡∏™:</b> <span id="vDispId" style="color:var(--primary-green); font-weight:bold;">...</span></div>
      </div>
      <div class="input-group"><label>‡∏£‡∏´‡∏±‡∏™‡∏ö‡πâ‡∏≤‡∏ô (Property ID)</label><input type="text" id="vPropId"></div>
      <div class="input-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label><input type="text" id="vClientName"></div>
      <div class="input-group"><label>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</label><textarea id="vNotes"></textarea></div>
      <button class="menu-btn" onclick="handleRecordVisit()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>

    <div id="propertiesPage" style="display:none;">
      <h3 style="margin-left:5px;">üè† ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ö‡πâ‡∏≤‡∏ô</h3>
      <div id="propertiesList"></div>
    </div>
  </div>

  <div id="bottomNav" class="bottom-nav" style="display:none;">
    <div class="nav-item active" onclick="openProperties('home')" id="navHome"><i class="fa-solid fa-house"></i><div>Home</div></div>
    <div class="nav-item" onclick="openProperties('sale')"><i class="fa-solid fa-tags"></i><div>‡∏Ç‡∏≤‡∏¢</div></div>
    <div class="nav-item" onclick="openProperties('rent')"><i class="fa-solid fa-key"></i><div>‡πÄ‡∏ä‡πà‡∏≤</div></div>
    <div class="nav-item" onclick="handleLogout()"><i class="fa-solid fa-sign-out"></i><div>‡∏≠‡∏≠‡∏Å</div></div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyLB6o3Nqm8QtYSkneLHDva0T8hxkLHVl5iu1EM2IrswK8uyPkGQ4VlvP77nXHIBMB7KA/exec"; 
    let currentRole = "customer", globalProfile = null, allHouses = [];

    async function initApp() {
      const urlParams = new URLSearchParams(window.location.search);
      const target = urlParams.get('page');
      const ph = localStorage.getItem('agent_phone'), ps = localStorage.getItem('agent_pass');

      if (ph && ps) {
        const res = await callApi({ action: "login", phone: ph, password: ps });
        if (res?.success) {
          globalProfile = res.profile; currentRole = res.role;
          if (target === 'visit') showVisitPage();
          else if (target === 'properties') openProperties('home');
          else switchPage('startPage');
        } else switchPage('loginPage');
      } else {
        if (target === 'register') switchPage('registerPage');
        else switchPage('startPage');
      }
      document.getElementById('loadingScreen').style.display = 'none';
    }

    function switchPage(id) {
      ['startPage','loginPage','registerPage','visitPage','propertiesPage'].forEach(p => document.getElementById(p).style.display = 'none');
      document.getElementById(id).style.display = 'block';
      document.getElementById('bottomNav').style.display = (id === 'propertiesPage') ? 'flex' : 'none';
    }

    function showVisitPage() {
      document.getElementById('vDispName').innerText = globalProfile.name;
      document.getElementById('vDispId').innerText = globalProfile.agentId;
      switchPage('visitPage');
    }

    async function handleRecordVisit() {
      const data = { action: "recordVisit", agentId: globalProfile.agentId, agentName: globalProfile.name, agentPhone: globalProfile.phone, propertyId: document.getElementById('vPropId').value, clientName: document.getElementById('vClientName').value, notes: document.getElementById('vNotes').value };
      if(!data.propertyId || !data.clientName) return Swal.fire('‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', 'warning');
      Swal.showLoading();
      const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(data) }).then(r => r.json());
      Swal.close();
      if(res.success) Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success').then(() => location.reload());
    }

    async function openProperties(cat) {
      switchPage('propertiesPage');
      if(allHouses.length === 0) {
        Swal.showLoading();
        allHouses = await callApi({ action: "getProperties", role: currentRole, lang: "th" });
        Swal.close();
      }
      renderList(cat);
    }

    function renderList(cat) {
      const list = document.getElementById('propertiesList'); list.innerHTML = '';
      const filtered = allHouses.filter(h => cat === 'home' || h[cat] === "Y" || h[cat] === "TRUE");
      filtered.forEach(h => {
        const s = h.status?.toLowerCase() || 'available';
        const sColor = s==='available' ? 'var(--st-available-txt)' : (s==='reserved' ? 'var(--st-reserved-txt)' : 'var(--st-sold-txt)');
        const sBg = s==='available' ? 'var(--st-available)' : (s==='reserved' ? 'var(--st-reserved)' : 'var(--st-sold)');
        
        let html = `<div class="house-card" style="border-left-color:${sColor}">
          <img src="${h.img || 'https://placehold.co/100'}" class="house-img">
          <div class="house-info">
            <div class="house-title">${h.title}</div>
            <div style="color:var(--app-red); font-weight:600;">‡∏ø ${h.price}</div>
            <div style="font-size:11px; color:#999; margin-top:3px;"><i class="fa-solid fa-bed"></i> ${h.bed} <i class="fa-solid fa-bath"></i> ${h.bath} | ID: ${h.id}</div>`;
        if(currentRole !== 'customer') html += `<div style="font-size:11px; color:var(--primary-green); margin-top:5px; border-top:1px dashed #eee; padding-top:5px;">üí∞ ‡∏Ñ‡∏≠‡∏°‡∏Ø: <b>${h.commission || '-'}</b></div>`;
        html += `</div><div class="status-badge" style="background:${sBg}; color:${sColor}">${h.status}</div></div>`;
        list.innerHTML += html;
      });
    }

    async function handleLogin() {
      const ph = document.getElementById('lPhone').value, ps = document.getElementById('lPass').value;
      Swal.showLoading();
      const res = await callApi({ action: "login", phone: ph, password: ps });
      Swal.close();
      if(res?.success) { localStorage.setItem('agent_phone', ph); localStorage.setItem('agent_pass', ps); location.reload(); }
      else Swal.fire('Error', '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏¥‡∏î', 'error');
    }

    async function handleRegister() {
      const data = { name: document.getElementById('rName').value, phone: document.getElementById('rPhone').value, lineId: document.getElementById('rLine').value, password: document.getElementById('rPass').value };
      Swal.showLoading();
      const res = await callApi({ action: "register", data: JSON.stringify(data) });
      Swal.close();
      if(res.success) Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏£‡∏±‡∏ö', 'success').then(() => switchPage('loginPage'));
    }

    async function callApi(p) { return await fetch(`${API_URL}?${new URLSearchParams(p).toString()}`).then(r => r.json()); }
    function handleLogout() { localStorage.clear(); location.reload(); }
    function openCustomerView() { currentRole = "customer"; openProperties('home'); }
  </script>
</body>
</html>
